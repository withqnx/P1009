<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ì°¸ì—¬í•˜ê¸° - ì†Œë¦¬ë¥¼ ë‹´ëŠ” ê¸€ì, í•œê¸€</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .pill { font-size:12px; padding:6px 10px; background:#EEF2FF; color:#4F46E5; border-radius:999px; font-weight:700; display:inline-block; }
    .hint { color:#6B7280; font-size:13px; }
    .hidden { display:none !important; }
    .stack { display:grid; gap:10px; }
    .row   { display:grid; gap:8px; }
    button[disabled]{opacity:.5; cursor:not-allowed;}
    #messageBox { margin-top:20px; padding:10px; border-radius:8px; }
    #messageBox.success { background:#ECFDF5; color:#065F46; }
    #messageBox.error { background:#FEF2F2; color:#991B1B; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">ì†Œë¦¬ë¥¼ ë‹´ëŠ” ê¸€ì, í•œê¸€</div>
      <nav>
        <a href="/">í™ˆ</a>
        <a href="/gallery">ì „ì‹œê´€</a>
        <a href="/admin" style="opacity:.6">ê´€ë¦¬</a>
      </nav>
    </header>

    <section class="card">
      <span class="pill">ì°¸ì—¬í•˜ê¸°</span>
      <h1>ì†Œë¦¬ë¥¼ ë‹´ê³ , ì†Œë¦¬ë¥¼ ë‚¨ê¸°ë‹¤</h1>
      <p class="lead">ì˜ì„±ì–´Â·ì˜íƒœì–´ë¥¼ ì…ë ¥í•˜ê³  ì§ì ‘ ì†Œë¦¬ ë‚´ì–´ ë…¹ìŒí•´ ì£¼ì„¸ìš”.</p>
    </section>

    <section class="card stack">
      <!-- ì˜ì„±ì–´ ì…ë ¥ -->
      <div class="row">
        <label for="word">ë‹¨ì–´ (ì˜ì„±ì–´Â·ì˜íƒœì–´) <span class="hint">ì˜ˆ: ì‚¬ê°ì‚¬ê°, ì² ì©, ë°”ìŠ¤ë½</span></label>
        <input id="word" type="text" placeholder="ì˜ˆ: ì‚¬ê°ì‚¬ê°">
      </div>

      <!-- ì„¤ëª… ì…ë ¥ -->
      <div class="row">
        <label for="description">ì„¤ëª…</label>
        <textarea id="description" rows="3" placeholder="ì™œ ì´ ì†Œë¦¬ë¥¼ ì„ íƒí–ˆëŠ”ì§€ ì„¤ëª…í•´ ì£¼ì„¸ìš”."></textarea>
      </div>

      <!-- ë…¹ìŒ ì»¨íŠ¸ë¡¤ -->
      <div class="row">
        <label>ì†Œë¦¬ ë…¹ìŒ</label>
        <div>
          <button id="recordBtn">ğŸ™ ë…¹ìŒ ì‹œì‘</button>
          <button id="stopBtn" disabled>â¹ ë…¹ìŒ ì •ì§€</button>
          <button id="playBtn" disabled>â–¶ ë¯¸ë¦¬ë“£ê¸°</button>
        </div>
        <audio id="audioPreview" controls class="hidden"></audio>
      </div>

      <!-- ì œì¶œ -->
      <button id="submitBtn" disabled>ì œì¶œí•˜ê¸°</button>
    </section>

    <section class="card hidden" id="messageBox"></section>
  </div>

  <script>
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const playBtn = document.getElementById("playBtn");
    const submitBtn = document.getElementById("submitBtn");
    const audioPreview = document.getElementById("audioPreview");
    const messageBox = document.getElementById("messageBox");

    let mediaRecorder, audioChunks = [], audioBlob;

    // ë…¹ìŒ ì‹œì‘
    recordBtn.onclick = async () => {
      audioChunks = [];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          audioPreview.src = URL.createObjectURL(audioBlob);
          audioPreview.classList.remove("hidden");
          playBtn.disabled = false;
          submitBtn.disabled = false;
        };
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        showMessage("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.", "error");
      }
    };

    // ë…¹ìŒ ì •ì§€
    stopBtn.onclick = () => {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
    };

    // ë¯¸ë¦¬ë“£ê¸°
    playBtn.onclick = () => {
      if (audioBlob) {
        audioPreview.play();
      }
    };

    // ì œì¶œ
    submitBtn.onclick = async () => {
      const word = document.getElementById("word").value.trim();
      const description = document.getElementById("description").value.trim();
      if (!word || !description || !audioBlob) {
        showMessage("ë‹¨ì–´, ì„¤ëª…, ë…¹ìŒ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤.", "error");
        return;
      }
      const formData = new FormData();
      formData.append("word", word);
      formData.append("description", description);
      formData.append("audio", audioBlob, "recording.webm");

      try {
        const res = await fetch("/api/submit", { method:"POST", body:formData });
        const data = await res.json();
        if (data.ok) {
          showMessage("ì œì¶œ ì™„ë£Œ! ì „ì‹œê´€ì—ì„œ í™•ì¸í•˜ì„¸ìš”.", "success");
          submitBtn.disabled = true;
          setTimeout(()=> window.location.href="/gallery", 1500);
        } else {
          throw new Error(data.error || "ì„œë²„ ì˜¤ë¥˜");
        }
      } catch (err) {
        showMessage("ì œì¶œ ì‹¤íŒ¨: " + err.message, "error");
      }
    };

    function showMessage(msg, type){
      messageBox.textContent = msg;
      messageBox.className = "card " + type;
      messageBox.classList.remove("hidden");
    }
  </script>
</body>
</html>
