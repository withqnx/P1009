<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>참여하기 - 소리를 담는 글자, 한글</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .pill { font-size:12px; padding:6px 10px; background:#EEF2FF; color:#4F46E5; border-radius:999px; font-weight:700; display:inline-block; }
    .hint { color:#6B7280; font-size:13px; }
    .hidden { display:none !important; }
    .stack { display:grid; gap:10px; }
    .row   { display:grid; gap:8px; }
    button[disabled]{opacity:.5; cursor:not-allowed;}
    #messageBox { margin-top:20px; padding:10px; border-radius:8px; }
    #messageBox.success { background:#ECFDF5; color:#065F46; }
    #messageBox.error { background:#FEF2F2; color:#991B1B; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">소리를 담는 글자, 한글</div>
      <nav>
        <a href="/">홈</a>
        <a href="/gallery">전시관</a>
        <a href="/admin" style="opacity:.6">관리</a>
      </nav>
    </header>

    <section class="card">
      <span class="pill">참여하기</span>
      <h1>소리를 담고, 소리를 남기다</h1>
      <p class="lead">의성어·의태어를 입력하고 직접 소리 내어 녹음해 주세요.</p>
    </section>

    <section class="card stack">
      <!-- 의성어 입력 -->
      <div class="row">
        <label for="word">단어 (의성어·의태어) <span class="hint">예: 사각사각, 철썩, 바스락</span></label>
        <input id="word" type="text" placeholder="예: 사각사각">
      </div>

      <!-- 설명 입력 -->
      <div class="row">
        <label for="description">설명</label>
        <textarea id="description" rows="3" placeholder="왜 이 소리를 선택했는지 설명해 주세요."></textarea>
      </div>

      <!-- 녹음 컨트롤 -->
      <div class="row">
        <label>소리 녹음</label>
        <div>
          <button id="recordBtn">🎙 녹음 시작</button>
          <button id="stopBtn" disabled>⏹ 녹음 정지</button>
          <button id="playBtn" disabled>▶ 미리듣기</button>
        </div>
        <audio id="audioPreview" controls class="hidden"></audio>
      </div>

      <!-- 제출 -->
      <button id="submitBtn" disabled>제출하기</button>
    </section>

    <section class="card hidden" id="messageBox"></section>
  </div>

  <script>
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const playBtn = document.getElementById("playBtn");
    const submitBtn = document.getElementById("submitBtn");
    const audioPreview = document.getElementById("audioPreview");
    const messageBox = document.getElementById("messageBox");

    let mediaRecorder, audioChunks = [], audioBlob;

    // 녹음 시작
    recordBtn.onclick = async () => {
      audioChunks = [];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          audioPreview.src = URL.createObjectURL(audioBlob);
          audioPreview.classList.remove("hidden");
          playBtn.disabled = false;
          submitBtn.disabled = false;
        };
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        showMessage("마이크 권한을 허용해주세요.", "error");
      }
    };

    // 녹음 정지
    stopBtn.onclick = () => {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
    };

    // 미리듣기
    playBtn.onclick = () => {
      if (audioBlob) {
        audioPreview.play();
      }
    };

    // 제출
    submitBtn.onclick = async () => {
      const word = document.getElementById("word").value.trim();
      const description = document.getElementById("description").value.trim();
      if (!word || !description || !audioBlob) {
        showMessage("단어, 설명, 녹음 모두 필요합니다.", "error");
        return;
      }
      const formData = new FormData();
      formData.append("word", word);
      formData.append("description", description);
      formData.append("audio", audioBlob, "recording.webm");

      try {
        const res = await fetch("/api/submit", { method:"POST", body:formData });
        const data = await res.json();
        if (data.ok) {
          showMessage("제출 완료! 전시관에서 확인하세요.", "success");
          submitBtn.disabled = true;
          setTimeout(()=> window.location.href="/gallery", 1500);
        } else {
          throw new Error(data.error || "서버 오류");
        }
      } catch (err) {
        showMessage("제출 실패: " + err.message, "error");
      }
    };

    function showMessage(msg, type){
      messageBox.textContent = msg;
      messageBox.className = "card " + type;
      messageBox.classList.remove("hidden");
    }
  </script>
</body>
</html>
