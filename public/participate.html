<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>참여하기 - 소리를 담는 글자, 한글</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .pill { font-size:12px; padding:6px 10px; background:#EEF2FF; color:#4F46E5; border-radius:999px; font-weight:700; display:inline-block; }
    .hint { color:#6B7280; font-size:13px; }
    .hidden { display:none !important; }
    .stack { display:grid; gap:10px; }
    .row   { display:grid; gap:8px; }
    button[disabled]{opacity:.5; cursor:not-allowed;}
    #msg { margin-top:16px; padding:10px 12px; border-radius:10px; display:none; }
    #msg.ok { background:#ECFDF5; color:#065F46; }
    #msg.err{ background:#FEF2F2; color:#991B1B; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">소리를 담는 글자, 한글</div>
      <nav>
        <a href="/">홈</a>
        <a href="/gallery">전시관</a>
        <a href="/admin" style="opacity:.6">관리</a>
      </nav>
    </header>

    <section class="card">
      <span class="pill">참여하기</span>
      <h1>소리를 담고, 소리를 남기다</h1>
      <p class="lead">
<br>[의성어]
<br>사물의 소리를 본뜬 말.
<br>
<br>여러분 주변에서 들리는 소리들을
<br>한글로 표현해보세요.
<br>
<br>한글이 소리를 본뜬 글자라면, 
<br>분명 가능할 겁니다.
<br>
<br>기존에 통용되던 의성어도 좋고
<br>여러분만의 독창적인 표현도 환영합니다.</p>
    </section>

    <section class="card stack">
      <!-- 의성어 -->
      <div class="row">
        <label for="word">단어 <span class="hint">예: 사각사각, 철썩, 바스락</span></label>
        <input id="word" type="text" placeholder="예: 사각사각">
      </div>

      <!-- 설명 -->
      <div class="row">
        <label for="description">설명</label>
        <textarea id="description" rows="3" placeholder="왜 이 소리를 선택했는지 한 줄로 적어주세요."></textarea>
      </div>

      <!-- 녹음 -->
      <div class="row">
        <label>소리 녹음</label>
        <div class="controls" style="gap:8px;">
          <button id="recBtn">🎙 녹음 시작</button>
          <button id="stopBtn" class="secondary" disabled>⏹ 정지</button>
          <button id="playBtn" class="secondary" disabled>▶ 미리듣기</button>
        </div>
        <audio id="preview" controls preload="metadata" class="hidden"></audio>
        <div id="hint" class="notice">마이크 권한을 허용해 주세요.</div>
      </div>

      <!-- 제출 -->
      <div class="controls">
        <button id="submitBtn" disabled>제출하기</button>
        <span id="status" class="notice"></span>
      </div>

      <div id="msg"></div>
    </section>
  </div>

<script>
  // ============ 유틸 =============
  const $ = id => document.getElementById(id);
  const word = $("word");
  const description = $("description");
  const recBtn = $("recBtn") || $("recordBtn");     // id가 다를 수도 있어 대비
  const stopBtn = $("stopBtn");
  const playBtn = $("playBtn");
  const preview = $("preview") || $("audioPreview");
  const submitBtn = $("submitBtn");
  const statusEl = $("status") || $("submitStatus");
  const msg = $("msg") || $("messageBox");
  const hint = $("hint") || { textContent: "" };

  let mediaRecorder = null;
  let chunks = [];
  let audioBlob = null;
  let chosenMime = null;

  function normalize(s=""){ return String(s).trim(); }
  function updateSubmitEnabled(){
    const ok = normalize(word?.value) && normalize(description?.value) && !!audioBlob;
    if (submitBtn) submitBtn.disabled = !ok;
  }
  function showMsg(text, type="ok"){
    if (!msg) return;
    msg.textContent = text;
    msg.className = (msg.className || "").replace(/\bok|err\b/g,"").trim();
    msg.classList.remove("hidden");
    msg.style.display = "block";
    if (type === "err") msg.classList.add("err"); else msg.classList.add("ok");
  }

  // ============ MIME 선택 로직 (iOS 대응) =============
  function pickBestMime(){
    const candidates = [
      "audio/mp4",           // iOS Safari가 가장 잘 재생 (AAC)
      "audio/aac",
      "audio/webm;codecs=opus",
      "audio/webm",
      "audio/ogg;codecs=opus",
      "audio/ogg",
    ];
    if (!window.MediaRecorder) return null;
    for (const t of candidates){
      if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
        return t;
      }
    }
    return ""; // 브라우저가 알아서 정하도록
  }

  // ============ 녹음 =============
  async function startRec(){
    try{
      // 마이크 권한
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      chunks = [];

      chosenMime = pickBestMime();
      try {
        mediaRecorder = chosenMime ? new MediaRecorder(stream, { mimeType: chosenMime }) 
                                   : new MediaRecorder(stream);
      } catch(e){
        // 어떤 이유로 실패하면 기본 생성 시도
        mediaRecorder = new MediaRecorder(stream);
      }

      mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstop = ()=>{
        // 수집된 청크로 Blob 생성 (타입은 우선 data의 type을 신뢰)
        const blobType = (chunks[0] && chunks[0].type) ? chunks[0].type : (chosenMime || "audio/mp4");
        audioBlob = new Blob(chunks, { type: blobType });
        // 미리듣기 준비
        preview.src = URL.createObjectURL(audioBlob);
        preview.load();
        preview.controls = true;
        if (playBtn) playBtn.disabled = false;
        hint.textContent = "녹음이 완료되었습니다. 미리듣기 가능.";
        updateSubmitEnabled();
      };

      mediaRecorder.start();
      if (recBtn) recBtn.disabled = true;
      if (stopBtn) stopBtn.disabled = false;
      hint.textContent = "녹음 중…";

    }catch(err){
      console.error("getUserMedia error:", err);
      hint.textContent = "마이크 권한이 필요하거나, 이 브라우저에서 녹음이 지원되지 않습니다.";
      // Fallback: 파일 업로드 카드 노출
      document.querySelector("#fileFallbackWrap")?.classList.remove("hidden");
    }
  }

  function stopRec(){
    try{
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
    } finally {
      if (stopBtn) stopBtn.disabled = true;
      if (recBtn) recBtn.disabled = false;
    }
  }

  function playPreview(){
    try{
      if (preview && preview.src) {
        preview.currentTime = 0;
        // 사용자 클릭 이벤트 안에서 play 호출 → 자동재생 차단 회피
        const p = preview.play();
        if (p && typeof p.catch === "function") p.catch(()=>{ /* 무음 차단 시 무시 */ });
      }
    }catch(e){ console.warn("preview play error:", e); }
  }

  // ============ 제출 =============
  async function submitForm(){
    const w = normalize(word?.value);
    const d = normalize(description?.value);
    if (!w || !d || !audioBlob) {
      showMsg("단어, 설명, 녹음이 모두 필요합니다.", "err");
      return;
    }
    submitBtn.disabled = true;
    if (statusEl) statusEl.textContent = "제출 중…";
    msg && (msg.style.display="none");

    try{
      const fd = new FormData();
      fd.append("word", w);
      fd.append("description", d);
      // 파일 확장자는 타입에 맞춰 대략 지정(서버는 MIME로 판단)
      const ext = audioBlob.type.includes("mp4") || audioBlob.type.includes("aac") ? "m4a"
                : audioBlob.type.includes("webm") ? "webm"
                : audioBlob.type.includes("ogg") ? "ogg" : "audio";
      fd.append("audio", audioBlob, `voice.${ext}`);

      const r = await fetch("/api/submit", { method:"POST", body: fd });
      const data = await r.json();
      if (!r.ok || !data.ok) throw new Error(data.error || "서버 오류");

      if (statusEl) statusEl.textContent = "";
      showMsg("제출 완료! 상단 ‘전시관’에서 확인할 수 있어요.", "ok");
      submitBtn.disabled = false; // 예전 폼처럼 자동 이동 없음
    }catch(e){
      console.error("submit error:", e);
      if (statusEl) statusEl.textContent = "";
      showMsg("제출 실패: " + (e.message || "오류"), "err");
      submitBtn.disabled = false;
    }
  }

  // ============ 파일 업로드 Fallback =============
  // MediaRecorder 미지원/실패 시: 사용자가 직접 녹음 파일을 올릴 수 있게
  const fileInput = document.querySelector("#fileFallback");
  fileInput?.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    audioBlob = f;
    preview.src = URL.createObjectURL(f);
    preview.load();
    preview.controls = true;
    if (playBtn) playBtn.disabled = false;
    hint.textContent = "파일이 선택되었습니다. 미리듣기 가능.";
    updateSubmitEnabled();
  });

  // ============ 이벤트 바인딩 =============
  recBtn?.addEventListener("click", startRec);
  stopBtn?.addEventListener("click", stopRec);
  playBtn?.addEventListener("click", playPreview);
  submitBtn?.addEventListener("click", submitForm);
  ["input","change"].forEach(ev=>{
    word?.addEventListener(ev, updateSubmitEnabled);
    description?.addEventListener(ev, updateSubmitEnabled);
  });

  // 초기 상태
  updateSubmitEnabled();
</script>

<!-- MediaRecorder 실패 대비: 파일 업로드 fallback UI (필요 시 보이도록) -->
<div id="fileFallbackWrap" class="hidden" style="margin-top:12px;">
  <div class="notice" style="margin-bottom:6px;">
    브라우저에서 녹음이 지원되지 않거나 권한이 거부되었습니다. 아래에서 녹음 파일을 업로드해 주세요.
  </div>
  <input id="fileFallback" type="file" accept="audio/*" />
</div>
</body>
</html>
