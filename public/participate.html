<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ì°¸ì—¬í•˜ê¸° - ì†Œë¦¬ë¥¼ ë‹´ëŠ” ê¸€ì, í•œê¸€</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .pill { font-size:12px; padding:6px 10px; background:#EEF2FF; color:#4F46E5; border-radius:999px; font-weight:700; display:inline-block; }
    .hint { color:#6B7280; font-size:13px; }
    .hidden { display:none !important; }
    .stack { display:grid; gap:10px; }
    .row   { display:grid; gap:8px; }
    button[disabled]{opacity:.5; cursor:not-allowed;}
    #msg { margin-top:16px; padding:10px 12px; border-radius:10px; display:none; }
    #msg.ok { background:#ECFDF5; color:#065F46; }
    #msg.err{ background:#FEF2F2; color:#991B1B; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">ì†Œë¦¬ë¥¼ ë‹´ëŠ” ê¸€ì, í•œê¸€</div>
      <nav>
        <a href="/">í™ˆ</a>
        <a href="/gallery">ì „ì‹œê´€</a>
        <a href="/admin" style="opacity:.6">ê´€ë¦¬</a>
      </nav>
    </header>

    <section class="card">
      <span class="pill">ì°¸ì—¬í•˜ê¸°</span>
      <h1>ì†Œë¦¬ë¥¼ ë‹´ê³ , ì†Œë¦¬ë¥¼ ë‚¨ê¸°ë‹¤</h1>
      <p class="lead">
<br>[ì˜ì„±ì–´]
<br>ì‚¬ë¬¼ì˜ ì†Œë¦¬ë¥¼ ë³¸ëœ¬ ë§.
<br>
<br>ì—¬ëŸ¬ë¶„ ì£¼ë³€ì—ì„œ ë“¤ë¦¬ëŠ” ì†Œë¦¬ë“¤ì„
<br>í•œê¸€ë¡œ í‘œí˜„í•´ë³´ì„¸ìš”.
<br>
<br>í•œê¸€ì´ ì†Œë¦¬ë¥¼ ë³¸ëœ¬ ê¸€ìë¼ë©´, 
<br>ë¶„ëª… ê°€ëŠ¥í•  ê²ë‹ˆë‹¤.
<br>
<br>ê¸°ì¡´ì— í†µìš©ë˜ë˜ ì˜ì„±ì–´ë„ ì¢‹ê³ 
<br>ì—¬ëŸ¬ë¶„ë§Œì˜ ë…ì°½ì ì¸ í‘œí˜„ë„ í™˜ì˜í•©ë‹ˆë‹¤.</p>
    </section>

    <section class="card stack">
      <!-- ì˜ì„±ì–´ -->
      <div class="row">
        <label for="word">ë‹¨ì–´ <span class="hint">ì˜ˆ: ì‚¬ê°ì‚¬ê°, ì² ì©, ë°”ìŠ¤ë½</span></label>
        <input id="word" type="text" placeholder="ì˜ˆ: ì‚¬ê°ì‚¬ê°">
      </div>

      <!-- ì„¤ëª… -->
      <div class="row">
        <label for="description">ì„¤ëª…</label>
        <textarea id="description" rows="3" placeholder="ì™œ ì´ ì†Œë¦¬ë¥¼ ì„ íƒí–ˆëŠ”ì§€ í•œ ì¤„ë¡œ ì ì–´ì£¼ì„¸ìš”."></textarea>
      </div>

      <!-- ë…¹ìŒ -->
      <div class="row">
        <label>ì†Œë¦¬ ë…¹ìŒ</label>
        <div class="controls" style="gap:8px;">
          <button id="recBtn">ğŸ™ ë…¹ìŒ ì‹œì‘</button>
          <button id="stopBtn" class="secondary" disabled>â¹ ì •ì§€</button>
          <button id="playBtn" class="secondary" disabled>â–¶ ë¯¸ë¦¬ë“£ê¸°</button>
        </div>
        <audio id="preview" controls preload="metadata" class="hidden"></audio>
        <div id="hint" class="notice">ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.</div>
      </div>

      <!-- ì œì¶œ -->
      <div class="controls">
        <button id="submitBtn" disabled>ì œì¶œí•˜ê¸°</button>
        <span id="status" class="notice"></span>
      </div>

      <div id="msg"></div>
    </section>
  </div>

<script>
  // ============ ìœ í‹¸ =============
  const $ = id => document.getElementById(id);
  const word = $("word");
  const description = $("description");
  const recBtn = $("recBtn") || $("recordBtn");     // idê°€ ë‹¤ë¥¼ ìˆ˜ë„ ìˆì–´ ëŒ€ë¹„
  const stopBtn = $("stopBtn");
  const playBtn = $("playBtn");
  const preview = $("preview") || $("audioPreview");
  const submitBtn = $("submitBtn");
  const statusEl = $("status") || $("submitStatus");
  const msg = $("msg") || $("messageBox");
  const hint = $("hint") || { textContent: "" };

  let mediaRecorder = null;
  let chunks = [];
  let audioBlob = null;
  let chosenMime = null;

  function normalize(s=""){ return String(s).trim(); }
  function updateSubmitEnabled(){
    const ok = normalize(word?.value) && normalize(description?.value) && !!audioBlob;
    if (submitBtn) submitBtn.disabled = !ok;
  }
  function showMsg(text, type="ok"){
    if (!msg) return;
    msg.textContent = text;
    msg.className = (msg.className || "").replace(/\bok|err\b/g,"").trim();
    msg.classList.remove("hidden");
    msg.style.display = "block";
    if (type === "err") msg.classList.add("err"); else msg.classList.add("ok");
  }

  // ============ MIME ì„ íƒ ë¡œì§ (iOS ëŒ€ì‘) =============
  function pickBestMime(){
    const candidates = [
      "audio/mp4",           // iOS Safariê°€ ê°€ì¥ ì˜ ì¬ìƒ (AAC)
      "audio/aac",
      "audio/webm;codecs=opus",
      "audio/webm",
      "audio/ogg;codecs=opus",
      "audio/ogg",
    ];
    if (!window.MediaRecorder) return null;
    for (const t of candidates){
      if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
        return t;
      }
    }
    return ""; // ë¸Œë¼ìš°ì €ê°€ ì•Œì•„ì„œ ì •í•˜ë„ë¡
  }

  // ============ ë…¹ìŒ =============
  async function startRec(){
    try{
      // ë§ˆì´í¬ ê¶Œí•œ
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      chunks = [];

      chosenMime = pickBestMime();
      try {
        mediaRecorder = chosenMime ? new MediaRecorder(stream, { mimeType: chosenMime }) 
                                   : new MediaRecorder(stream);
      } catch(e){
        // ì–´ë–¤ ì´ìœ ë¡œ ì‹¤íŒ¨í•˜ë©´ ê¸°ë³¸ ìƒì„± ì‹œë„
        mediaRecorder = new MediaRecorder(stream);
      }

      mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstop = ()=>{
        // ìˆ˜ì§‘ëœ ì²­í¬ë¡œ Blob ìƒì„± (íƒ€ì…ì€ ìš°ì„  dataì˜ typeì„ ì‹ ë¢°)
        const blobType = (chunks[0] && chunks[0].type) ? chunks[0].type : (chosenMime || "audio/mp4");
        audioBlob = new Blob(chunks, { type: blobType });
        // ë¯¸ë¦¬ë“£ê¸° ì¤€ë¹„
        preview.src = URL.createObjectURL(audioBlob);
        preview.load();
        preview.controls = true;
        if (playBtn) playBtn.disabled = false;
        hint.textContent = "ë…¹ìŒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¯¸ë¦¬ë“£ê¸° ê°€ëŠ¥.";
        updateSubmitEnabled();
      };

      mediaRecorder.start();
      if (recBtn) recBtn.disabled = true;
      if (stopBtn) stopBtn.disabled = false;
      hint.textContent = "ë…¹ìŒ ì¤‘â€¦";

    }catch(err){
      console.error("getUserMedia error:", err);
      hint.textContent = "ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•˜ê±°ë‚˜, ì´ ë¸Œë¼ìš°ì €ì—ì„œ ë…¹ìŒì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      // Fallback: íŒŒì¼ ì—…ë¡œë“œ ì¹´ë“œ ë…¸ì¶œ
      document.querySelector("#fileFallbackWrap")?.classList.remove("hidden");
    }
  }

  function stopRec(){
    try{
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
    } finally {
      if (stopBtn) stopBtn.disabled = true;
      if (recBtn) recBtn.disabled = false;
    }
  }

  function playPreview(){
    try{
      if (preview && preview.src) {
        preview.currentTime = 0;
        // ì‚¬ìš©ì í´ë¦­ ì´ë²¤íŠ¸ ì•ˆì—ì„œ play í˜¸ì¶œ â†’ ìë™ì¬ìƒ ì°¨ë‹¨ íšŒí”¼
        const p = preview.play();
        if (p && typeof p.catch === "function") p.catch(()=>{ /* ë¬´ìŒ ì°¨ë‹¨ ì‹œ ë¬´ì‹œ */ });
      }
    }catch(e){ console.warn("preview play error:", e); }
  }

  // ============ ì œì¶œ =============
  async function submitForm(){
    const w = normalize(word?.value);
    const d = normalize(description?.value);
    if (!w || !d || !audioBlob) {
      showMsg("ë‹¨ì–´, ì„¤ëª…, ë…¹ìŒì´ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤.", "err");
      return;
    }
    submitBtn.disabled = true;
    if (statusEl) statusEl.textContent = "ì œì¶œ ì¤‘â€¦";
    msg && (msg.style.display="none");

    try{
      const fd = new FormData();
      fd.append("word", w);
      fd.append("description", d);
      // íŒŒì¼ í™•ì¥ìëŠ” íƒ€ì…ì— ë§ì¶° ëŒ€ëµ ì§€ì •(ì„œë²„ëŠ” MIMEë¡œ íŒë‹¨)
      const ext = audioBlob.type.includes("mp4") || audioBlob.type.includes("aac") ? "m4a"
                : audioBlob.type.includes("webm") ? "webm"
                : audioBlob.type.includes("ogg") ? "ogg" : "audio";
      fd.append("audio", audioBlob, `voice.${ext}`);

      const r = await fetch("/api/submit", { method:"POST", body: fd });
      const data = await r.json();
      if (!r.ok || !data.ok) throw new Error(data.error || "ì„œë²„ ì˜¤ë¥˜");

      if (statusEl) statusEl.textContent = "";
      showMsg("ì œì¶œ ì™„ë£Œ! ìƒë‹¨ â€˜ì „ì‹œê´€â€™ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.", "ok");
      submitBtn.disabled = false; // ì˜ˆì „ í¼ì²˜ëŸ¼ ìë™ ì´ë™ ì—†ìŒ
    }catch(e){
      console.error("submit error:", e);
      if (statusEl) statusEl.textContent = "";
      showMsg("ì œì¶œ ì‹¤íŒ¨: " + (e.message || "ì˜¤ë¥˜"), "err");
      submitBtn.disabled = false;
    }
  }

  // ============ íŒŒì¼ ì—…ë¡œë“œ Fallback =============
  // MediaRecorder ë¯¸ì§€ì›/ì‹¤íŒ¨ ì‹œ: ì‚¬ìš©ìê°€ ì§ì ‘ ë…¹ìŒ íŒŒì¼ì„ ì˜¬ë¦´ ìˆ˜ ìˆê²Œ
  const fileInput = document.querySelector("#fileFallback");
  fileInput?.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    audioBlob = f;
    preview.src = URL.createObjectURL(f);
    preview.load();
    preview.controls = true;
    if (playBtn) playBtn.disabled = false;
    hint.textContent = "íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë¯¸ë¦¬ë“£ê¸° ê°€ëŠ¥.";
    updateSubmitEnabled();
  });

  // ============ ì´ë²¤íŠ¸ ë°”ì¸ë”© =============
  recBtn?.addEventListener("click", startRec);
  stopBtn?.addEventListener("click", stopRec);
  playBtn?.addEventListener("click", playPreview);
  submitBtn?.addEventListener("click", submitForm);
  ["input","change"].forEach(ev=>{
    word?.addEventListener(ev, updateSubmitEnabled);
    description?.addEventListener(ev, updateSubmitEnabled);
  });

  // ì´ˆê¸° ìƒíƒœ
  updateSubmitEnabled();
</script>

<!-- MediaRecorder ì‹¤íŒ¨ ëŒ€ë¹„: íŒŒì¼ ì—…ë¡œë“œ fallback UI (í•„ìš” ì‹œ ë³´ì´ë„ë¡) -->
<div id="fileFallbackWrap" class="hidden" style="margin-top:12px;">
  <div class="notice" style="margin-bottom:6px;">
    ë¸Œë¼ìš°ì €ì—ì„œ ë…¹ìŒì´ ì§€ì›ë˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ë…¹ìŒ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.
  </div>
  <input id="fileFallback" type="file" accept="audio/*" />
</div>
</body>
</html>
