<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ì°¸ì—¬í•˜ê¸° - ì†Œë¦¬ë¥¼ ë‹´ëŠ” ê¸€ì, í•œê¸€</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .pill { font-size:12px; padding:6px 10px; background:#EEF2FF; color:#4F46E5; border-radius:999px; font-weight:700; display:inline-block; }
    .hint { color:#6B7280; font-size:13px; }
    .hidden { display:none !important; }
    .stack { display:grid; gap:10px; }
    .row   { display:grid; gap:8px; }
    button[disabled]{opacity:.5; cursor:not-allowed;}
    #msg { margin-top:16px; padding:10px 12px; border-radius:10px; display:none; }
    #msg.ok { background:#ECFDF5; color:#065F46; }
    #msg.err{ background:#FEF2F2; color:#991B1B; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">ì†Œë¦¬ë¥¼ ë‹´ëŠ” ê¸€ì, í•œê¸€</div>
      <nav>
        <a href="/">í™ˆ</a>
        <a href="/gallery">ì „ì‹œê´€</a>
        <a href="/admin" style="opacity:.6">ê´€ë¦¬</a>
      </nav>
    </header>

    <section class="card">
      <span class="pill">ì°¸ì—¬í•˜ê¸°</span>
      <h1>ì†Œë¦¬ë¥¼ ë‹´ê³ , ì†Œë¦¬ë¥¼ ë‚¨ê¸°ë‹¤</h1>
      <p class="lead">ì˜ì„±ì–´Â·ì˜íƒœì–´ë¥¼ ì…ë ¥í•˜ê³  ì§ì ‘ ì†Œë¦¬ ë‚´ì–´ ë…¹ìŒí•´ ì£¼ì„¸ìš”.</p>
    </section>

    <section class="card stack">
      <!-- ì˜ì„±ì–´ -->
      <div class="row">
        <label for="word">ë‹¨ì–´ (ì˜ì„±ì–´Â·ì˜íƒœì–´) <span class="hint">ì˜ˆ: ì‚¬ê°ì‚¬ê°, ì² ì©, ë°”ìŠ¤ë½</span></label>
        <input id="word" type="text" placeholder="ì˜ˆ: ì‚¬ê°ì‚¬ê°">
      </div>

      <!-- ì„¤ëª… -->
      <div class="row">
        <label for="description">ì„¤ëª…</label>
        <textarea id="description" rows="3" placeholder="ì™œ ì´ ì†Œë¦¬ë¥¼ ì„ íƒí–ˆëŠ”ì§€ í•œ ì¤„ë¡œ ì ì–´ì£¼ì„¸ìš”."></textarea>
      </div>

      <!-- ë…¹ìŒ -->
      <div class="row">
        <label>ì†Œë¦¬ ë…¹ìŒ</label>
        <div class="controls" style="gap:8px;">
          <button id="recBtn">ğŸ™ ë…¹ìŒ ì‹œì‘</button>
          <button id="stopBtn" class="secondary" disabled>â¹ ì •ì§€</button>
          <button id="playBtn" class="secondary" disabled>â–¶ ë¯¸ë¦¬ë“£ê¸°</button>
        </div>
        <audio id="preview" controls class="hidden"></audio>
        <div id="hint" class="notice">ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.</div>
      </div>

      <!-- ì œì¶œ -->
      <div class="controls">
        <button id="submitBtn" disabled>ì œì¶œí•˜ê¸°</button>
        <span id="status" class="notice"></span>
      </div>

      <div id="msg"></div>
    </section>
  </div>

  <script>
    // ìš”ì†Œ
    const $ = id => document.getElementById(id);
    const word = $("word");
    const description = $("description");
    const recBtn = $("recBtn");
    const stopBtn = $("stopBtn");
    const playBtn = $("playBtn");
    const preview = $("preview");
    const submitBtn = $("submitBtn");
    const statusEl = $("status");
    const msg = $("msg");
    const hint = $("hint");

    // ìƒíƒœ
    let mediaRecorder = null;
    let chunks = [];
    let audioBlob = null;

    function normalize(s=""){ return String(s).trim(); }
    function updateSubmitEnabled(){
      const ok = normalize(word.value) && normalize(description.value) && !!audioBlob;
      submitBtn.disabled = !ok;
    }

    // ë…¹ìŒ ì‹œì‘
    recBtn.addEventListener("click", async () => {
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        chunks = [];
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(chunks, { type: "audio/webm" });
          preview.src = URL.createObjectURL(audioBlob);
          preview.classList.remove("hidden");
          playBtn.disabled = false;
          hint.textContent = "ë…¹ìŒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¯¸ë¦¬ë“£ê¸° ê°€ëŠ¥.";
          updateSubmitEnabled();
        };

        mediaRecorder.start();
        recBtn.disabled = true;
        stopBtn.disabled = false;
        hint.textContent = "ë…¹ìŒ ì¤‘â€¦";
      } catch (err) {
        console.error(err);
        hint.textContent = "ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.";
      }
    });

    // ë…¹ìŒ ì •ì§€
    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        stopBtn.disabled = true;
        recBtn.disabled = false;
      }
    });

    // ë¯¸ë¦¬ë“£ê¸° (ì‚¬ìš©ì í´ë¦­ ì‹œì—ë§Œ ì¬ìƒ)
    playBtn.addEventListener("click", () => {
      if (preview.src) {
        preview.currentTime = 0;
        preview.play().catch(()=>{});
      }
    });

    // ì…ë ¥ ë³€í™”ë¡œ ì œì¶œ ë²„íŠ¼ í™œì„±í™”
    ["input","change"].forEach(ev=>{
      word.addEventListener(ev, updateSubmitEnabled);
      description.addEventListener(ev, updateSubmitEnabled);
    });

    // ì œì¶œ (ì „ì‹œê´€ ìë™ ì´ë™/ë²„íŠ¼ ë³€ê²½ ì—†ìŒ!)
    submitBtn.addEventListener("click", async () => {
      const w = normalize(word.value);
      const d = normalize(description.value);
      if (!w || !d || !audioBlob) { return; }

      submitBtn.disabled = true;
      statusEl.textContent = "ì œì¶œ ì¤‘â€¦";
      msg.style.display = "none"; msg.className = ""; msg.textContent = "";

      try{
        const fd = new FormData();
        fd.append("word", w);
        fd.append("description", d);
        fd.append("audio", audioBlob, "voice.webm");

        const r = await fetch("/api/submit", { method:"POST", body: fd });
        const data = await r.json();
        if (!r.ok || !data.ok) throw new Error(data.error || "ì„œë²„ ì˜¤ë¥˜");

        statusEl.textContent = "";
        msg.textContent = "ì œì¶œ ì™„ë£Œ! ìƒë‹¨ ë©”ë‰´ì˜ â€˜ì „ì‹œê´€â€™ì—ì„œ ë°”ë¡œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.";
        msg.className = "ok"; msg.classList.add("ok"); msg.style.display = "block";

      }catch(e){
        console.error(e);
        statusEl.textContent = "";
        msg.textContent = "ì œì¶œ ì‹¤íŒ¨: " + (e.message || "ì˜¤ë¥˜");
        msg.className = "err"; msg.classList.add("err"); msg.style.display = "block";
        submitBtn.disabled = false; // ì¬ì‹œë„ í—ˆìš©
      }
    });
  </script>
</body>
</html>
